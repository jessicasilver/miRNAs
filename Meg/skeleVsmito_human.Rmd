---
title: "Human whole muscle vs mitochondrial miRNA Analysis"
author: "Jessica Silver (additional analysis by Megan Soria)"
date: 2023-07-09
output:
  html_document:
    theme: lumen
    toc: yes
    toc_float: true
  html_notebook:
    theme: lumen
    toc: yes
    toc_float: true
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

source: https://github.com/jessicasilver/miRNAs

# Summary and background information
The data used in this analysis is from an exercise intervention study in 12 human participants conducted by **[name]** on **[year]**. Muscle biopsies were taken at 3 time points for each participant: pre-exercise, post-exercise, and 3 hours post-exercise <br> <br>
A whole muscle and a mitochondrial fraction is extracted from each biopsy. <br> <br>

This analysis focuses on the differential expression of the miRNA of human whole muscle and mitochondrial transcriptome.  

# Load and install packages
The following packages are required for the following analysis and visualisation. The code below will automatically install and load packages from CRAN. Packages from Bioconductor can be installed by un-commenting (removing the # before the line or selecting the code block and pressing ctrl+shift+c) and running  the code block for the Bioconductor packages. Sometimes these installations will throw an error and specific packages might need to be installed manually.

```{r echo = T, results = 'hide'}
suppressPackageStartupMessages({c(
  # packages from CRAN
  if(!require("prettydoc")) install.packages("prettydoc"), library(prettydoc),
  if(!require("readxl")) install.packages("readxl"), library(readxl),
  if(!require("dplyr")) install.packages("dplyr"), library(dplyr),
  if(!require("RColorBrewer")) install.packages("RColorBrewer"), library(RColorBrewer),
  if(!require("circlize")) install.packages("circlize"), library(circlize),
  library(ggplot2),
  library(RNAseqQC),
  # packages from Bioconductor
  # run the installation code when needed
  # if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
  #   BiocManager::install(c("DESeq2", "ComplexHeatmap", "EnhancedVolcano", "org.Hs.eg.db")),
  library(DESeq2),
  library(ComplexHeatmap),
  library(EnhancedVolcano),
  library(cowplot),
  library(PCAtools),
  library(fgsea),
  library(msigdbr),
  library(tidyverse),
  library(dplyr),
  )})

# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("DESeq2")
  
# load self-authored functions 
source("functions.R")
```

***
# Load data for skeletal muscle
```{r}
muscle.cts <- read.csv("data/silver_muscle raw.csv", sep=",", row.names = 1) #keeps miR identifiers as rownames
muscle.cts[is.na(muscle.cts)] <-0 #replace NA with 0 #now a num not int
muscle.cts <- as.matrix(muscle.cts) #convert to matrix

#read in column datafile aka sample information file
muscle.coldata <- read.csv("data/silver_muscle condition.csv", sep = ",", header = TRUE) # do not incl row.names=1

muscle.coldata <- muscle.coldata[,c("sampleid","condition")]
muscle.coldata$condition <- factor(muscle.coldata$condition)
muscle.coldata$sampleid <- factor(muscle.coldata$sampleid)

all(rownames(muscle.coldata$sampleid) == colnames(muscle.cts)) #check these both come back as TRUE
```

# Load data for mitochondria
```{r}
mito.cts <- read.csv("data/silver_hmt raw_by group.csv", sep=",", row.names = 1) #keeps miR identifiers as rownames
mito.cts[is.na(mito.cts)] <-0 #replace NA with 0 #now a num not int
mito.cts <- as.matrix(mito.cts) #convert to matrix

#read in column datafile aka sample information file
mito.coldata <- read.csv("data/silver_hmt condition_by group.csv", sep = ",", header = TRUE) # do not incl row.names=1

mito.coldata <- mito.coldata[,c("sampleid","condition")]
mito.coldata$condition <- factor(mito.coldata$condition)
mito.coldata$sampleid <- factor(mito.coldata$sampleid)

all(rownames(mito.coldata$sampleid) == colnames(mito.cts)) #check these both come back as TRUE
```
# Histogram for gene counts of mitochondria vs muscle miRNAs
```{r}
# muscle
select2 <- as.matrix(assay(muscle.vst)) #scale ntd

#pull out samples by group or time-point
PRE <- select2[,1:9]
POST_0h <- select2[,10:21]
POST_3h <- select2[,22:33]

#row (i.e. miRNA) means by group or time-point
rmeansPRE <- as.vector(rowMeans(PRE))
rmeansPOST_0h <- as.vector(rowMeans(POST_0h))
rmeansPOST_3h <- as.vector(rowMeans(POST_3h))

df.muscle <- data.frame(rmeansPRE, rmeansPOST_0h, rmeansPOST_3h) %>% 
  mutate(Sample = "Muscle") %>% 
  mutate(genes = row.names(select2))


# mitochondria
select2 <- as.matrix(assay(mito.vst)) #scale ntd

#pull out samples by group or time-point
PRE <- select2[,1:9]
POST_0h <- select2[,10:21]
POST_3h <- select2[,22:33]

#row (i.e. miRNA) means by group or time-point
rmeansPRE <- as.vector(rowMeans(PRE))
rmeansPOST_0h <- as.vector(rowMeans(POST_0h))
rmeansPOST_3h <- as.vector(rowMeans(POST_3h))

df.mito <- data.frame(rmeansPRE, rmeansPOST_0h, rmeansPOST_3h) %>% 
  mutate(Sample = "Mito")%>% 
  mutate(genes = row.names(select2))

p <- function(v) {
  if(length(v) > 1){
    f=paste(v[1], "&", v[2])
  }else(f=paste(v))
  return(f)
 }
# pre muscle and mito
PRE.combined <- df.mito %>% 
  select(rmeansPRE, Sample, genes) %>%
  bind_rows(select(df.muscle, rmeansPRE, Sample, genes)) %>%
  group_by(genes) %>%
  summarise(rmeansPRE = mean(rmeansPRE),
            Sample = p(as.character(Sample)))

# 3hr post muscle and mito
POST3h.combined <- df.mito %>% 
  select(rmeansPOST_3h, Sample, genes) %>%
  bind_rows(select(df.muscle, rmeansPOST_3h, Sample, genes)) %>%
  group_by(genes) %>%
  summarise(rmeansPOST_3h = mean(rmeansPOST_3h),
            Sample = p(as.character(Sample)))

# post muscle and mito
POST.combined <- df.mito %>% 
  select(rmeansPOST_0h, Sample, genes) %>%
  bind_rows(select(df.muscle, rmeansPOST_0h, Sample, genes)) %>%
  group_by(genes) %>%
  summarise(rmeansPOST_0h = mean(rmeansPOST_0h),
            Sample = p(as.character(Sample)))

# plot
theme_set(theme_classic(14))

ggplot(data=PRE.combined, aes(x=rmeansPRE, group=Sample, fill=Sample)) +
    geom_density(adjust=1.5, alpha=.6) +
  labs(title = "Normalised counts of miRNAs in humans:",
       subtitle = "mitochondira and muscle pre-exercise") +
    theme(plot.title=element_text(hjust=0.5),
          plot.subtitle=element_text(hjust=0.5))

ggplot(data=POST.combined, aes(x=rmeansPOST_0h, group=Sample, fill=Sample)) +
    geom_density(adjust=1.5, alpha=.6) +
    labs(title = "Normalised counts of miRNAs in humans:",
       subtitle = "mitochondira and muscle Post-exercise") +
    theme(plot.title=element_text(hjust=0.5),
          plot.subtitle=element_text(hjust=0.5))

ggplot(data=POST3h.combined, aes(x=rmeansPOST_3h, group=Sample, fill=Sample)) +
    geom_density(adjust=1.5, alpha=.6) +
    labs(title = "Normalised counts of miRNAs in humans:",
       subtitle = "mitochondira and muscle 3 hours post-exercise") +
    theme(plot.title=element_text(hjust=0.5),
          plot.subtitle=element_text(hjust=0.5))

```


# Differential expression analysis 
The following differential expression analysis is conducted using the DESeq2 package

## Differential expression anlysis for muscle
```{r}
#set up deseq2 object
dds <- DESeqDataSetFromMatrix(countData = muscle.cts,
                              colData = muscle.coldata,
                              design = ~ condition)
x <- dim(dds)

dds$condition <- relevel(dds$condition, ref = "PRE") #set your baseline. #hsa=PRE #rno=SED

keep <- rowSums(counts(dds)) >=10  
dds <- dds[keep,]

cat("Before filtering for lowcounts: ", x, "\n",
    "After filtering for lowcounts: ", dim(dds))

dds <- DESeq(dds) #run deseq2

# normalise: use varianceStabilizingTransformation() for nrow(dds) < 1000
muscle.vst <- varianceStabilizingTransformation(dds, blind=F) 

#extract the results for each comparison that you are interested in 
muscle.res <- as.data.frame(results(dds, contrast=c("condition","3HPOST","PRE")))
muscle.res <- muscle.res[order(muscle.res$pvalue),]
summary(muscle.res)
head(muscle.res)
```

## Differential expression anlysis for mitochondria
```{r}
#set up deseq2 object
dds <- DESeqDataSetFromMatrix(countData = mito.cts,
                              colData = mito.coldata,
                              design = ~ condition)
x <- dim(dds)

dds$condition <- relevel(dds$condition, ref = "PRE") #set your baseline. #hsa=PRE #rno=SED

keep <- rowSums(counts(dds)) >=10
dds <- dds[keep,]

cat("Before filtering for lowcounts: ", x, "\n",
    "After filtering for lowcounts: ", dim(dds))

dds <- DESeq(dds) #run deseq2

# normalise: use varianceStabilizingTransformation() for nrow(dds) < 1000
mito.vst <- varianceStabilizingTransformation(dds, blind=F) 

#extract the results for each comparison that you are interested in 
mito.res <- as.data.frame(results(dds, contrast=c("condition","3HPOST","PRE")))
mito.res <- mito.res[order(mito.res$pvalue),]
summary(mito.res)
head(mito.res)
```
# Visualisations

## PCA plots
```{r}
pca.muscle <- plot_pca(muscle.vst, PC_x = 1, PC_y = 2, color_by = "condition", point_rel_size = 5)
pca.mito <- plot_pca(mito.vst, PC_x = 1, PC_y = 2, color_by = "condition", point_rel_size = 5)
```


## Volcano plots
```{r}
# muscle
vplot.muscle <- EnhancedVolcano(as.data.frame(muscle.res), x="log2FoldChange", y="padj", lab = NA, 
                pCutoff = 1e-4, FCcutoff = 1, title = "", subtitle = "Muscle miRNA DE Genes", gridlines.major = FALSE, gridlines.minor = FALSE, 
                axisLabSize = 14, titleLabSize = 0, subtitleLabSize = 16, captionLabSize = 14, legendLabSize = 14, legendIconSize = 4,
                col = c("grey30", "royalblue", "forestgreen", "red2"))

# mito
vplot.mito <- EnhancedVolcano(as.data.frame(mito.res), x="log2FoldChange", y="padj", lab = NA, 
                pCutoff = 1e-4, FCcutoff = 1, title = "", subtitle = "Mitochondrial miRNA DE Genes", gridlines.major = FALSE, gridlines.minor = FALSE, 
                axisLabSize = 14, titleLabSize = 0, subtitleLabSize = 16, captionLabSize = 14, legendLabSize = 14, legendIconSize = 4,
                col = c("grey30", "royalblue", "forestgreen", "red2"))

vplot.muscle
vplot.mito

```


## Heatmaps
```{r fig.width=16.22}
# muscle
count_mat <- z_score(muscle.vst, muscle.res)
hmap_name <- "Muscle miRNAs"
hmap.muscle <- hmap(50, as.data.frame(muscle.res), count_mat, hmap_name)

# mito
count_mat <- z_score(mito.vst, mito.res)
hmap_name <- "Mitochondrial miRNAs"
hmap.mito <- hmap(50, as.data.frame(mito.res), count_mat, hmap_name)

hmap.muscle
hmap.mito
```


# Pathway analysis
## Convert ENSEMBL IDs
```{r}
# preVs3hrPost - muscle
muscle.ensmbl <- muscle.res %>%
    mutate(ENSEMBL = rownames(muscle.res))

# preVs3hrPost - mito
mito.ensmbl <- mito.res %>%
    mutate(ENSEMBL = rownames(mito.res))

```

## Get gene set data 
Using the **msigdbr library** from the [Broad Institute's Molecular Signatures Database](https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp).
```{r}
H <- as.data.frame(msigdbr(species = "Homo sapiens", 
                           category = "H")) 
H_list = split(x = H$ensembl_gene, f = H$gs_name)

# GO-Biological pathways
GO_BP <- msigdbr(species = "Homo sapiens", 
                 category = "C5", 
                 subcategory = "BP")
GO_BP_list = split(x = GO_BP$ensembl_gene, f = GO_BP$gs_name)

# KEGG
KEGG <- msigdbr(species = "Homo sapiens", 
                category = "C2", 
                subcategory = "KEGG")

KEGG_list = split(x = KEGG$ensembl_gene, f = KEGG$gs_name)

head(H)
```

# Define Significant genes
```{r}

signif_muscle <- muscle.ensmbl %>% 
  dplyr::select(ENSEMBL, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(ENSEMBL) %>% 
  summarize(stat=mean(stat))

signif_muscle <- deframe(signif_muscle)

signif_mito <- mito.ensmbl %>% 
  dplyr::select(ENSEMBL, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(ENSEMBL) %>% 
  summarize(stat=mean(stat))

signif_mito <- deframe(signif_mito)
```

## Run GSEA
```{r}
# set ScoreType ("std" if neg and pos values present; "pos" if only pos; "neg" if only neg)
  score_test <- function(gsea_data_vec){
      if(min(gsea_data_vec) < 0 & max(gsea_data_vec) > 0){
     type <- "std"
    } else if(min(gsea_data_vec) < 0 & max(gsea_data_vec) < 0){
      type <- "neg"
    } else{
      type <- "pos"
    }
    return(type)
  }

# muscle
ScoreType <- score_test(signif_muscle)
fgsea_muscle <- fgsea(pathways=GO_BP_list, 
                            stats=signif_muscle,
                            scoreType = ScoreType, 
                            minSize = 15, 
                            nPermSimple = 10000)

fgsea_preVs3hrPost <- fgsea_preVs3hrPost %>%
  # filter(padj <= 0.05) %>% 
  as_tibble() %>%
  arrange(desc(NES)) %>%
  mutate(pathway = gsub("HALLMARK_","", pathway),
         pathway = gsub("_"," ", pathway))
```


# Comparison of enriched pathways